<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ’– AI í”„ë¡œí•„ ì‚¬ì§„ ë¶„ì„ê¸° ğŸ’–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"
      defer
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Gamja Flower", cursive;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgb(253, 242, 248);
      }

      /* ë©”ì¸ íƒ€ì´í‹€ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
      .main-title {
        font-size: clamp(0.9rem, 6.5vw, 3rem);
        line-height: 1.1;
        white-space: nowrap;
      }

      /* ë©”ì¸ ì»¨í…Œì´ë„ˆ - ì¤‘ì•™ ì •ë ¬ ë³´ì¥ */
      .main-container {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        padding: 1.5rem;
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        position: relative;
        overflow: hidden;
      }

      /* ì „ì²´ ë˜í¼ */
      .app-wrapper {
        width: 100%;
        max-width: 400px;
        margin: 1rem;
      }
      /* ë°˜ì‘í˜• ì»¨í…Œì´ë„ˆ ë„ˆë¹„ */
      @media (min-width: 480px) {
        .app-wrapper,
        .main-container {
          max-width: 480px;
        }
      }
      @media (min-width: 640px) {
        .app-wrapper,
        .main-container {
          max-width: 560px;
        }
      }
      @media (min-width: 768px) {
        .app-wrapper,
        .main-container {
          max-width: 640px;
        }
      }
      @media (min-width: 1024px) {
        .app-wrapper,
        .main-container {
          max-width: 720px;
        }
      }
      @media (min-width: 1280px) {
        .app-wrapper,
        .main-container {
          max-width: 800px;
        }
      }
      /* ê·€ì—¬ìš´ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
      .bouncing-loader {
        display: flex;
        justify-content: center;
      }
      .bouncing-loader > div {
        width: 20px;
        height: 20px;
        margin: 3px 6px;
        border-radius: 50%;
        background-color: #fca5a5; /* red-300 */
        opacity: 1;
        animation: bouncing-loader 0.8s infinite alternate;
      }
      .bouncing-loader > div:nth-child(2) {
        animation-delay: 0.2s;
      }
      .bouncing-loader > div:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes bouncing-loader {
        to {
          opacity: 0.1;
          transform: translateY(-16px);
        }
      }
      /* ê²°ê³¼ ì ìˆ˜ ë°” ì• ë‹ˆë©”ì´ì…˜ */
      @keyframes fill-bar {
        from {
          width: 0%;
        }
        to {
          width: var(--target-width);
        }
      }
      .score-bar-fill {
        animation: fill-bar 1.5s ease-out forwards;
      }
      /* í™”ë©´ ì „í™˜ íš¨ê³¼ */
      .view-section {
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      }
      .view-section.hidden {
        opacity: 0;
        transform: scale(0.95);
        pointer-events: none;
        position: absolute;
      }
    </style>
  </head>
  <body>
    <div class="app-wrapper">
      <div class="main-container">
        <!-- Initial Upload View -->
        <div id="upload-section" class="view-section">
          <div class="text-center">
            <h1 class="main-title font-bold text-gray-800">
              âœ¨ AI í”„ë¡œí•„ ì‚¬ì§„ ë¶„ì„ê¸° âœ¨
            </h1>
            <p class="text-gray-500 mt-2 text-lg">
              ë‹¹ì‹ ì˜ ë§¤ë ¥, AIê°€ ì°¾ì•„ë“œë ¤ìš”!
            </p>
          </div>
          <div class="mt-8">
            <div
              class="w-full h-64 border-2 border-dashed border-pink-300 rounded-2xl flex items-center justify-center bg-pink-100 bg-opacity-50"
            >
              <img
                id="image-preview"
                src=""
                alt="Image preview"
                class="hidden max-h-full max-w-full rounded-lg"
              />
              <div id="upload-placeholder" class="text-center text-pink-400">
                <svg
                  class="mx-auto h-16 w-16"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"
                  />
                </svg>
                <p class="mt-2 text-xl">í´ë¦­í•´ì„œ ì‚¬ì§„ ì˜¬ë¦¬ê¸°!</p>
              </div>
            </div>
          </div>
          <div class="mt-6 space-y-3">
            <input
              type="file"
              id="image-upload"
              class="hidden"
              accept="image/*"
            />
            <button
              onclick="document.getElementById('image-upload').click()"
              class="w-full bg-fuchsia-500 text-white font-bold py-3 px-4 rounded-xl text-lg hover:bg-fuchsia-600 transition-all duration-300 transform hover:scale-105 shadow-lg"
            >
              ì•¨ë²”ì—ì„œ ì‚¬ì§„ ì„ íƒ ğŸ’–
            </button>
            <button
              id="next-button"
              class="w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl text-lg hover:bg-slate-900 transition-all duration-300 transform hover:scale-105 shadow-lg hidden"
            >
              ì •ë³´ ì…ë ¥í•˜ê³  ê²°ê³¼ë³´ê¸° âœ¨
            </button>
          </div>
        </div>

        <!-- Contact Info View -->
        <div id="contact-section" class="view-section hidden">
          <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-800">
              ê²°ê³¼ë¥¼ ë³´ê¸° ì „, ë§ˆì§€ë§‰ ë‹¨ê³„!
            </h2>
            <p class="text-gray-500 mt-4 text-lg">
              ê°œì¸ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì…”ì•¼ ê²°ê³¼ë¥¼ ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br />
              ê²°ê³¼ê°€ ë‚˜ì˜¤ê¸° ê¹Œì§€ ì•½ 6ì´ˆê°€ ì†Œìš”ë©ë‹ˆë‹¤.
            </p>
          </div>
          <form id="contact-form" class="space-y-4 mt-8" novalidate>
            <input
              type="text"
              id="user-name"
              placeholder="ì´ë¦„ (í•œê¸€/ì˜ë¬¸ë§Œ ê°€ëŠ¥)"
              class="w-full text-lg p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
              required
            />
            <input
              type="tel"
              id="user-contact"
              placeholder="010-1234-5678"
              maxlength="13"
              class="w-full text-lg p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
              required
            />
            <div
              class="flex items-start space-x-3 rounded-lg bg-gray-50 p-3 border border-gray-200"
            >
              <input
                id="contact-consent"
                type="checkbox"
                class="mt-1 h-5 w-5 text-fuchsia-500 border-gray-300 rounded"
              />
              <label
                for="contact-consent"
                class="text-gray-700 text-base leading-6"
              >
                ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.
                <span class="text-gray-400 text-sm block"
                  >ì´ë¦„, ì—°ë½ì²˜, ì—…ë¡œë“œí•œ ì‚¬ì§„ì€ ê²°ê³¼ ìƒì„± ë° ì„œë¹„ìŠ¤ ê³ ë„í™”
                  ëª©ì ì—ë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
                  <a
                    href="privacy.html"
                    target="_blank"
                    class="text-fuchsia-600 underline"
                    >ìì„¸íˆ ë³´ê¸°</a
                  >
                </span>
              </label>
            </div>
            <button
              type="submit"
              class="w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-900 transition-colors text-lg"
            >
              ê²°ê³¼ ë¶„ì„ ì‹œì‘í•˜ê¸° ğŸš€
            </button>
          </form>
          <p
            id="form-success-message"
            class="text-center text-green-600 mt-4 hidden"
          >
            ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!
          </p>
        </div>

        <!-- Loading View -->
        <div id="loading-section" class="view-section hidden text-center py-16">
          <div class="bouncing-loader mx-auto">
            <div></div>
            <div></div>
            <div></div>
          </div>
          <p class="text-gray-600 font-semibold text-2xl mt-8">
            AIê°€ ë‹¹ì‹ ì˜ ë§¤ë ¥ì„ ìŠ¤ìº” ì¤‘ì´ì—ìš”! âœ¨
          </p>
          <p class="text-gray-400 mt-2 text-lg">
            ë‘ê·¼ë‘ê·¼... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
          </p>
        </div>

        <!-- Result View -->
        <div id="result-section" class="view-section hidden">
          <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-800">AI ë¶„ì„ ê²°ê³¼!</h2>
            <img
              id="result-image"
              src=""
              alt="Analyzed image"
              class="mt-4 w-48 h-48 mx-auto rounded-full object-cover shadow-2xl border-4 border-white"
            />
          </div>

          <div class="mt-8 space-y-6">
            <!-- ì¸ë¬¼ ì ìˆ˜ -->
            <div>
              <div class="flex justify-between items-center mb-1">
                <h3 class="font-bold text-xl text-gray-700">ğŸ¤µ ì¸ë¬¼</h3>
                <span
                  id="figure-score"
                  class="font-bold text-xl text-fuchsia-500"
                ></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-5">
                <div
                  id="figure-bar"
                  class="bg-fuchsia-500 h-5 rounded-full score-bar-fill"
                  style="width: 0%"
                ></div>
              </div>
              <p
                id="figure-critique"
                class="text-base text-gray-700 mt-2 p-3 bg-fuchsia-50 rounded-lg"
              ></p>
            </div>
            <!-- ë°°ê²½ ì ìˆ˜ -->
            <div>
              <div class="flex justify-between items-center mb-1">
                <h3 class="font-bold text-xl text-gray-700">ğŸï¸ ë°°ê²½</h3>
                <span
                  id="background-score"
                  class="font-bold text-xl text-emerald-500"
                ></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-5">
                <div
                  id="background-bar"
                  class="bg-emerald-500 h-5 rounded-full score-bar-fill"
                  style="width: 0%"
                ></div>
              </div>
              <p
                id="background-critique"
                class="text-base text-gray-700 mt-2 p-3 bg-emerald-50 rounded-lg"
              ></p>
            </div>
            <!-- ê°ì„± ì ìˆ˜ -->
            <div>
              <div class="flex justify-between items-center mb-1">
                <h3 class="font-bold text-xl text-gray-700">âœ¨ ê°ì„±</h3>
                <span
                  id="vibe-score"
                  class="font-bold text-xl text-amber-500"
                ></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-5">
                <div
                  id="vibe-bar"
                  class="bg-amber-500 h-5 rounded-full score-bar-fill"
                  style="width: 0%"
                ></div>
              </div>
              <p
                id="vibe-critique"
                class="text-base text-gray-700 mt-2 p-3 bg-amber-50 rounded-lg"
              ></p>
            </div>
          </div>

          <div class="mt-8 text-center bg-gray-100 p-4 rounded-xl shadow-inner">
            <h3 class="font-bold text-gray-800 text-lg">AIì˜ ìµœì¢… í•œ ì¤„ í‰</h3>
            <p id="final-critique" class="text-xl mt-2 text-gray-700 italic">
              "
            </p>
          </div>

          <div
            class="mt-8 text-center border-t-2 border-dashed border-pink-200 pt-6"
          >
            <h3 class="text-2xl font-bold text-gray-800">
              ë² ëŸ´ëŒ„ë¯¸ : ë‚¨ì„±ê·¸ë£¨ë° í”„ë¡œí•„ ì„œë¹„ìŠ¤
            </h3>
            <p class="text-gray-600 mt-2 text-lg">
              ì¸ìƒ í”„ë¡œí•„ ì‚¬ì§„, ì „ë¬¸ê°€ì™€ í•¨ê»˜!
            </p>
            <div class="flex justify-center space-x-4 mt-4">
              <a
                href="https://www.instagram.com/better.than.me2040/"
                target="_blank"
                rel="noopener noreferrer"
                class="bg-gradient-to-r from-pink-500 to-orange-400 text-white py-2 px-5 rounded-lg hover:shadow-lg transition-shadow text-base"
                >ì¸ìŠ¤íƒ€ê·¸ë¨</a
              >
              <a
                href="https://open.kakao.com/o/sDAisnDh"
                target="_blank"
                rel="noopener noreferrer"
                class="bg-yellow-400 text-gray-800 py-2 px-5 rounded-lg hover:shadow-lg transition-shadow text-base"
                >ì˜¤í”ˆì±„íŒ…</a
              >
            </div>
            <p class="text-sm text-gray-500 mt-2">
              í”„ë¡œí•„ì‚¬ì§„ ë° ëƒ‰ì •í•œ ì™¸ëª¨í‰ê°€ë¥¼ ì›í•œë‹¤ë©´ ì˜¤í”ˆì±„íŒ…ìœ¼ë¡œ ì—°ë½ì£¼ì„¸ìš”
            </p>
          </div>

          <div class="mt-6 text-center">
            <button
              onclick="resetApp()"
              class="w-full bg-fuchsia-500 text-white font-bold py-3 px-4 rounded-xl text-lg hover:bg-fuchsia-600 transition-all duration-300 transform hover:scale-105 shadow-lg"
            >
              ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ ë˜ í•˜ê¸°! ğŸ“¸
            </button>
          </div>
        </div>

        <!-- Custom Alert Modal -->
        <div
          id="alert-modal"
          class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
        >
          <div
            class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center transform transition-all animate-in zoom-in-75"
          >
            <p id="alert-message" class="text-gray-700 text-xl"></p>
            <button
              onclick="closeModal()"
              class="mt-8 bg-fuchsia-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-fuchsia-600 transition-colors text-lg"
            >
              ì•Œê² ì–´ìš”!
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const uploadSection = document.getElementById("upload-section");
      const contactSection = document.getElementById("contact-section");
      const loadingSection = document.getElementById("loading-section");
      const resultSection = document.getElementById("result-section");
      const imageUpload = document.getElementById("image-upload");
      const imagePreview = document.getElementById("image-preview");
      const uploadPlaceholder = document.getElementById("upload-placeholder");
      const nextButton = document.getElementById("next-button");
      const resultImage = document.getElementById("result-image");
      const contactForm = document.getElementById("contact-form");

      const alertModal = document.getElementById("alert-modal");
      const alertMessage = document.getElementById("alert-message");

      let uploadedImageBase64 = null;
      // ìš”ì²­ ìƒê´€ê´€ê³„ë¥¼ ìœ„í•œ ê³ ìœ  ID ìƒì„± (ë‘ ë‹¨ê³„ ì „ì†¡ì— ì‚¬ìš©)
      let requestId =
        crypto && crypto.randomUUID
          ? crypto.randomUUID()
          : `${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
      // Google Apps Script ì›¹ì•± URL (ì‹œíŠ¸ ê¸°ë¡ìš©)
      // const scriptURL = "<moved-to-server>"; // Apps Script í˜¸ì¶œì€ ì„œë²„(Netlify í•¨ìˆ˜)ì—ì„œë§Œ ìˆ˜í–‰

      // ë°©ë¬¸ì/í™˜ê²½ ë©”íƒ€ ìˆ˜ì§‘ (clientId + FingerprintJS + IP/UA/lang/referrer)
      window.__clientId =
        localStorage.getItem("clientId") ||
        (() => {
          const id =
            crypto && crypto.randomUUID
              ? crypto.randomUUID()
              : `${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
          try {
            localStorage.setItem("clientId", id);
          } catch (_) {}
          return id;
        })();
      window.__ua = navigator.userAgent;
      window.__lang =
        navigator.language ||
        (navigator.languages && navigator.languages[0]) ||
        "";
      window.__referrer = document.referrer || "";

      window.__visitorId = "";
      if (window.FingerprintJS && FingerprintJS.load) {
        FingerprintJS.load()
          .then((fp) => fp.get())
          .then((res) => {
            window.__visitorId = res.visitorId;
          })
          .catch(() => {});
      }

      // ìµœì´ˆ ìœ ì… referrer ë³´ì¡´ (ë¸Œë¼ìš°ì € ì •ì±…/ì§ì ‘ ë°©ë¬¸ìœ¼ë¡œ ë¹„ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³´ì¡° ì‹ í˜¸ë¡œ ì €ì¥)
      try {
        if (!localStorage.getItem("firstReferrer") && document.referrer) {
          localStorage.setItem("firstReferrer", document.referrer);
        }
      } catch (_) {}

      // visitorId ì¤€ë¹„ë¥¼ ì ì‹œ ëŒ€ê¸° (FingerprintJSê°€ ë¹„ë™ê¸°ì—¬ì„œ ì´ˆê¸° ì œì¶œ ì‹œ ëˆ„ë½ ë°©ì§€)
      async function waitForVisitorId(timeoutMs = 800) {
        const start = Date.now();
        while (!window.__visitorId && Date.now() - start < timeoutMs) {
          await new Promise((r) => setTimeout(r, 50));
        }
        return window.__visitorId || "";
      }

      window.__clientIp = "";
      fetch("https://api.ipify.org?format=json")
        .then((r) => r.json())
        .then((d) => {
          window.__clientIp = d.ip;
        })
        .catch(() => {});

      // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
      imageUpload.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            uploadedImageBase64 = e.target.result;
            imagePreview.src = uploadedImageBase64;
            imagePreview.classList.remove("hidden");
            uploadPlaceholder.classList.add("hidden");
            nextButton.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        }
      });

      // 'ì •ë³´ ì…ë ¥' ë²„íŠ¼ í´ë¦­ -> ì—°ë½ì²˜ í¼ìœ¼ë¡œ ì´ë™
      nextButton.addEventListener("click", () => {
        if (!uploadedImageBase64) {
          showAlert("ë¨¼ì € ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
          return;
        }
        switchView("contact-section");
      });

      // ì—°ë½ì²˜ ì…ë ¥ ìë™ í¬ë§·íŒ…
      document
        .getElementById("user-contact")
        .addEventListener("input", (event) => {
          let value = event.target.value.replace(/[^0-9]/g, ""); // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°

          if (value.length >= 3) {
            value = value.substring(0, 3) + "-" + value.substring(3);
          }
          if (value.length >= 8) {
            value = value.substring(0, 8) + "-" + value.substring(8, 12);
          }

          event.target.value = value;
        });

      // ì´ë¦„ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
      function validateName(name) {
        const trimmedName = name.trim();

        // ë¹ˆ ë¬¸ìì—´ì´ê±°ë‚˜ ê³µë°±ë§Œ ìˆëŠ” ê²½ìš°
        if (!trimmedName || trimmedName.length < 2) {
          return false;
        }

        // ì—°ì†ëœ ê³µë°±ì´ ìˆëŠ”ì§€ í™•ì¸
        if (trimmedName.includes("  ")) {
          return false;
        }

        // í•œê¸€, ì˜ë¬¸, ê³µë°±ë§Œ í—ˆìš©, 2-10ê¸€ì
        const nameRegex = /^[ê°€-í£a-zA-Z\s]{2,10}$/;
        if (!nameRegex.test(trimmedName)) {
          return false;
        }

        // ì˜ì„±ì–´ë‚˜ ë¬´ì˜ë¯¸í•œ íŒ¨í„´ ê²€ì‚¬
        const invalidPatterns = [
          /^(.)\1+$/, // ê°™ì€ ê¸€ì ë°˜ë³µ (ì˜ˆ: ê°€ê°€ê°€, aaa)
          /^[ã„±-ã…ã…-ã…£]+$/, // ììŒì´ë‚˜ ëª¨ìŒë§Œ
          /(í•˜{2,}|íˆ{2,}|í›„{2,}|í—¤{2,}|í˜¸{2,})/, // í•˜í•˜í•˜, íˆíˆíˆ ë“±
          /^(í•˜|íˆ|í›„|í—¤|í˜¸|ã…‹|ã…|ã„·|ã„´|ã„¹|ã…|ã…‚|ã……|ã…‡|ã…ˆ|ã…Š|ã…Œ|ã…)+$/, // ì˜ì„±ì–´/ìëª¨ ë°˜ë³µ
          /^[0-9!@#$%^&*()_+=\-\[\]{}|;:,.<>?]+$/, // ìˆ«ìë‚˜ íŠ¹ìˆ˜ë¬¸ìë§Œ
          /(test|í…ŒìŠ¤íŠ¸|ã…‹ã…‹+|ã…ã…+|ã„·ã„·|ã„´ã„´)/i, // í…ŒìŠ¤íŠ¸/ì±„íŒ… ìš©ì–´
          /(í•˜íˆí›„í—¤í˜¸|ì•„í•˜í•˜í•˜|ìš°í•˜í•˜|ìœ¼í•˜í•˜)/, // ëŒ€í‘œ ì˜ì„±ì–´
        ];

        for (const pattern of invalidPatterns) {
          if (pattern.test(trimmedName)) {
            return false;
          }
        }

        return true;
      }

      // ì—°ë½ì²˜ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
      function validatePhoneNumber(phone) {
        const phoneRegex = /^010-\d{4}-\d{4}$/;
        return phoneRegex.test(phone);
      }

      // ì—°ë½ì²˜ í¼ ì œì¶œ -> ë¶„ì„ ì‹œì‘
      contactForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const name = document.getElementById("user-name").value;
        const contact = document.getElementById("user-contact").value;

        if (!name || !contact) {
          showAlert("ì´ë¦„ê³¼ ì—°ë½ì²˜ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
          return;
        }

        if (!validateName(name)) {
          showAlert(
            "ì˜¬ë°”ë¥¸ ì‚¬ëŒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”! ì˜ì„±ì–´ë‚˜ ë¬´ì˜ë¯¸í•œ ë¬¸ìëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          );
          return;
        }

        if (!validatePhoneNumber(contact)) {
          showAlert("ì—°ë½ì²˜ëŠ” 010-1234-5678 í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!");
          return;
        }

        const consentChecked =
          document.getElementById("contact-consent")?.checked;
        if (!consentChecked) {
          showAlert("ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì£¼ì„¸ìš”.");
          return;
        }

        // UI ìƒíƒœ ë³€ê²½: ë¡œë”©
        switchView("loading-section");
        // ì„œë²„ë¡œ ë‹¨ì¼ ìš”ì²­ (create + analyze + update)
        try {
          // ì œì¶œ ì§ì „ ì ì‹œ visitorId ëŒ€ê¸°
          await waitForVisitorId(800);
          let persistedReferrer = "";
          try {
            persistedReferrer = localStorage.getItem("firstReferrer") || "";
          } catch (_) {}

          const payload = {
            mode: "full",
            requestId,
            name,
            contact,
            timestamp: new Date().toLocaleString("ko-KR"),
            imageBase64: uploadedImageBase64,
            consent: !!consentChecked,
            clientId: window.__clientId || "",
            visitorId: window.__visitorId || "",
            ip: window.__clientIp || "",
            ua: window.__ua || "",
            lang: window.__lang || "",
            referrer: window.__referrer || persistedReferrer || "",
          };

          const res = await fetch("/.netlify/functions/analyzeImage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            throw new Error(`Server error ${res.status}`);
          }
          const data = await res.json();
          const result = data.result || data; // í˜¸í™˜ ì²˜ë¦¬

          if (!result.isValid) {
            showAlert(
              result.reason ||
                "ì•—! ì‹¤ì œ ì¸ë¬¼ ì‚¬ì§„ì„ ë„£ì–´ì•¼ ì •í™•í•œ í‰ê°€ê°€ ê°€ëŠ¥í•´ìš”."
            );
            resetToUpload();
            return;
          }

          displayResults(result);
        } catch (error) {
          console.error("Error during analysis:", error);
          showAlert(
            "ë¶„ì„ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
          );
          resetToUpload();
        }
      });

      // Gemini API í˜¸ì¶œ í•¨ìˆ˜ (ìˆ˜ì •ë¨)
      async function callGeminiAPI(prompt, imageBase64) {
        const apiUrl = `/.netlify/functions/analyzeImage`;
        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // *** FIX: promptì™€ imageBase64ë¥¼ í•¨ê»˜ ë³´ëƒ…ë‹ˆë‹¤. ***
            body: JSON.stringify({
              prompt: prompt, // <-- ì´ ë¶€ë¶„ì„ ì¶”ê°€!
              imageBase64: imageBase64,
            }),
          });

          if (!response.ok) {
            throw new Error(
              `Serverless function failed with status ${response.status}`
            );
          }

          const result = await response.json();

          // AIê°€ ìœ í•´ì„± ë“±ìœ¼ë¡œ ë‹µë³€ì„ ê±°ë¶€í–ˆì„ ê²½ìš°ì˜ ì²˜ë¦¬
          if (result.promptFeedback && result.promptFeedback.blockReason) {
            console.error(
              "Analysis blocked by API:",
              result.promptFeedback.blockReason
            );
            showAlert("AIê°€ ë¶„ì„ì„ ê±°ë¶€í–ˆì–´ìš”. ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.");
            throw new Error("API content blocked");
          }

          if (result.candidates && result.candidates[0].content.parts[0].text) {
            return result.candidates[0].content.parts[0].text;
          } else {
            throw new Error(
              "Invalid API response format from serverless function"
            );
          }
        } catch (error) {
          console.error("Error calling serverless function:", error);
          if (error.message !== "API content blocked") {
            showAlert(
              "ë¶„ì„ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
            );
          }
          throw error; // ì˜¤ë¥˜ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ í›„ì† ì²˜ë¦¬ë¥¼ ë§‰ìŠµë‹ˆë‹¤.
        }
      }

      // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
      function displayResults(data) {
        resultImage.src = uploadedImageBase64;

        document.getElementById(
          "figure-score"
        ).textContent = `${data.figureScore}ì `;
        document.getElementById(
          "background-score"
        ).textContent = `${data.backgroundScore}ì `;
        document.getElementById(
          "vibe-score"
        ).textContent = `${data.vibeScore}ì `;

        const figureBar = document.getElementById("figure-bar");
        const backgroundBar = document.getElementById("background-bar");
        const vibeBar = document.getElementById("vibe-bar");

        // ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ìŠ¤íƒ€ì¼ ë³€ìˆ˜ ì„¤ì •
        figureBar.style.setProperty("--target-width", `${data.figureScore}%`);
        backgroundBar.style.setProperty(
          "--target-width",
          `${data.backgroundScore}%`
        );
        vibeBar.style.setProperty("--target-width", `${data.vibeScore}%`);

        document.getElementById("figure-critique").textContent =
          data.figureCritique;
        document.getElementById("background-critique").textContent =
          data.backgroundCritique;
        document.getElementById("vibe-critique").textContent =
          data.vibeCritique;
        document.getElementById(
          "final-critique"
        ).textContent = `"${data.finalCritique}"`;

        // UI ìƒíƒœ ë³€ê²½: ê²°ê³¼
        switchView("result-section");
      }

      // ì»¤ìŠ¤í…€ ì•Œë¦¼ì°½ ë³´ì´ê¸°
      function showAlert(message) {
        alertMessage.textContent = message;
        alertModal.classList.remove("hidden");
      }

      // ì»¤ìŠ¤í…€ ì•Œë¦¼ì°½ ë‹«ê¸°
      function closeModal() {
        alertModal.classList.add("hidden");
      }

      function switchView(viewId) {
        document.querySelectorAll(".view-section").forEach((section) => {
          section.classList.add("hidden");
        });
        document.getElementById(viewId).classList.remove("hidden");
      }

      // ì´ˆê¸° ì—…ë¡œë“œ í™”ë©´ìœ¼ë¡œ ë¦¬ì…‹
      function resetToUpload() {
        switchView("upload-section");
      }

      // ì „ì²´ ì•± ë¦¬ì…‹
      function resetApp() {
        uploadedImageBase64 = null;
        imagePreview.src = "";
        imagePreview.classList.add("hidden");
        uploadPlaceholder.classList.remove("hidden");
        nextButton.classList.add("hidden");
        contactForm.reset();
        resetToUpload();
      }
    </script>
  </body>
</html>
