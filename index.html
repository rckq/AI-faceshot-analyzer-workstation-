<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>💖 AI 프로필 사진 분석기 💖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"
      defer
    ></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Gamja Flower", cursive;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgb(253, 242, 248);
      }

      /* 메인 타이틀 반응형 스타일 */
      .main-title {
        font-size: clamp(0.9rem, 6.5vw, 3rem);
        line-height: 1.1;
        white-space: nowrap;
      }

      /* 메인 컨테이너 - 중앙 정렬 보장 */
      .main-container {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        padding: 1.5rem;
        background: white;
        border-radius: 1.5rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        position: relative;
        overflow: hidden;
      }

      /* 전체 래퍼 */
      .app-wrapper {
        width: 100%;
        max-width: 400px;
        margin: 1rem;
      }
      /* 반응형 컨테이너 너비 */
      @media (min-width: 480px) {
        .app-wrapper,
        .main-container {
          max-width: 480px;
        }
      }
      @media (min-width: 640px) {
        .app-wrapper,
        .main-container {
          max-width: 560px;
        }
      }
      @media (min-width: 768px) {
        .app-wrapper,
        .main-container {
          max-width: 640px;
        }
      }
      @media (min-width: 1024px) {
        .app-wrapper,
        .main-container {
          max-width: 720px;
        }
      }
      @media (min-width: 1280px) {
        .app-wrapper,
        .main-container {
          max-width: 800px;
        }
      }
      /* 귀여운 로딩 애니메이션 */
      .bouncing-loader {
        display: flex;
        justify-content: center;
      }
      .bouncing-loader > div {
        width: 20px;
        height: 20px;
        margin: 3px 6px;
        border-radius: 50%;
        background-color: #fca5a5; /* red-300 */
        opacity: 1;
        animation: bouncing-loader 0.8s infinite alternate;
      }
      .bouncing-loader > div:nth-child(2) {
        animation-delay: 0.2s;
      }
      .bouncing-loader > div:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes bouncing-loader {
        to {
          opacity: 0.1;
          transform: translateY(-16px);
        }
      }
      /* 결과 점수 바 애니메이션 */
      @keyframes fill-bar {
        from {
          width: 0%;
        }
        to {
          width: var(--target-width);
        }
      }
      .score-bar-fill {
        animation: fill-bar 1.5s ease-out forwards;
      }
      /* 화면 전환 효과 */
      .view-section {
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      }
      .view-section.hidden {
        opacity: 0;
        transform: scale(0.95);
        pointer-events: none;
        position: absolute;
      }
    </style>
  </head>
  <body>
    <div class="app-wrapper">
      <div class="main-container">
        <!-- Initial Upload View -->
        <div id="upload-section" class="view-section">
          <div class="text-center">
            <h1 class="main-title font-bold text-gray-800">
              ✨ AI 프로필 사진 분석기 ✨
            </h1>
            <p class="text-gray-500 mt-2 text-lg">
              당신의 매력, AI가 찾아드려요!
            </p>
          </div>
          <div class="mt-8">
            <div
              class="w-full h-64 border-2 border-dashed border-pink-300 rounded-2xl flex items-center justify-center bg-pink-100 bg-opacity-50"
            >
              <img
                id="image-preview"
                src=""
                alt="Image preview"
                class="hidden max-h-full max-w-full rounded-lg"
              />
              <div id="upload-placeholder" class="text-center text-pink-400">
                <svg
                  class="mx-auto h-16 w-16"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"
                  />
                </svg>
                <p class="mt-2 text-xl">클릭해서 사진 올리기!</p>
              </div>
            </div>
          </div>
          <div class="mt-6 space-y-3">
            <input
              type="file"
              id="image-upload"
              class="hidden"
              accept="image/*"
            />
            <button
              onclick="document.getElementById('image-upload').click()"
              class="w-full bg-fuchsia-500 text-white font-bold py-3 px-4 rounded-xl text-lg hover:bg-fuchsia-600 transition-all duration-300 transform hover:scale-105 shadow-lg"
            >
              앨범에서 사진 선택 💖
            </button>
            <button
              id="next-button"
              class="w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl text-lg hover:bg-slate-900 transition-all duration-300 transform hover:scale-105 shadow-lg hidden"
            >
              정보 입력하고 결과보기 ✨
            </button>
          </div>
        </div>

        <!-- Contact Info View -->
        <div id="contact-section" class="view-section hidden">
          <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-800">
              결과를 보기 전, 마지막 단계!
            </h2>
            <p class="text-gray-500 mt-4 text-lg">
              개인정보를 입력해주셔야 결과를 보실 수 있습니다.<br />
              결과가 나오기 까지 약 6초가 소요됩니다.
            </p>
          </div>
          <form id="contact-form" class="space-y-4 mt-8" novalidate>
            <input
              type="text"
              id="user-name"
              placeholder="이름 (한글/영문만 가능)"
              class="w-full text-lg p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
              required
            />
            <input
              type="tel"
              id="user-contact"
              placeholder="010-1234-5678"
              maxlength="13"
              class="w-full text-lg p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-400"
              required
            />
            <div
              class="flex items-start space-x-3 rounded-lg bg-gray-50 p-3 border border-gray-200"
            >
              <input
                id="contact-consent"
                type="checkbox"
                class="mt-1 h-5 w-5 text-fuchsia-500 border-gray-300 rounded"
              />
              <label
                for="contact-consent"
                class="text-gray-700 text-base leading-6"
              >
                개인정보 수집 및 이용에 동의합니다.
                <span class="text-gray-400 text-sm block"
                  >이름, 연락처, 업로드한 사진은 결과 생성 및 서비스 고도화
                  목적에만 사용됩니다.
                  <a
                    href="privacy.html"
                    target="_blank"
                    class="text-fuchsia-600 underline"
                    >자세히 보기</a
                  >
                </span>
              </label>
            </div>
            <button
              type="submit"
              class="w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-900 transition-colors text-lg"
            >
              결과 분석 시작하기 🚀
            </button>
          </form>
          <p
            id="form-success-message"
            class="text-center text-green-600 mt-4 hidden"
          >
            정보가 성공적으로 제출되었습니다!
          </p>
        </div>

        <!-- Loading View -->
        <div id="loading-section" class="view-section hidden text-center py-16">
          <div class="bouncing-loader mx-auto">
            <div></div>
            <div></div>
            <div></div>
          </div>
          <p class="text-gray-600 font-semibold text-2xl mt-8">
            AI가 당신의 매력을 스캔 중이에요! ✨
          </p>
          <p class="text-gray-400 mt-2 text-lg">
            두근두근... 잠시만 기다려주세요!
          </p>
        </div>

        <!-- Result View -->
        <div id="result-section" class="view-section hidden">
          <div class="text-center">
            <h2 class="text-3xl font-bold text-gray-800">AI 분석 결과!</h2>
            <img
              id="result-image"
              src=""
              alt="Analyzed image"
              class="mt-4 w-48 h-48 mx-auto rounded-full object-cover shadow-2xl border-4 border-white"
            />
          </div>

          <div class="mt-8 space-y-6">
            <!-- 인물 점수 -->
            <div>
              <div class="flex justify-between items-center mb-1">
                <h3 class="font-bold text-xl text-gray-700">🤵 인물</h3>
                <span
                  id="figure-score"
                  class="font-bold text-xl text-fuchsia-500"
                ></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-5">
                <div
                  id="figure-bar"
                  class="bg-fuchsia-500 h-5 rounded-full score-bar-fill"
                  style="width: 0%"
                ></div>
              </div>
              <p
                id="figure-critique"
                class="text-base text-gray-700 mt-2 p-3 bg-fuchsia-50 rounded-lg"
              ></p>
            </div>
            <!-- 배경 점수 -->
            <div>
              <div class="flex justify-between items-center mb-1">
                <h3 class="font-bold text-xl text-gray-700">🏞️ 배경</h3>
                <span
                  id="background-score"
                  class="font-bold text-xl text-emerald-500"
                ></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-5">
                <div
                  id="background-bar"
                  class="bg-emerald-500 h-5 rounded-full score-bar-fill"
                  style="width: 0%"
                ></div>
              </div>
              <p
                id="background-critique"
                class="text-base text-gray-700 mt-2 p-3 bg-emerald-50 rounded-lg"
              ></p>
            </div>
            <!-- 감성 점수 -->
            <div>
              <div class="flex justify-between items-center mb-1">
                <h3 class="font-bold text-xl text-gray-700">✨ 감성</h3>
                <span
                  id="vibe-score"
                  class="font-bold text-xl text-amber-500"
                ></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-5">
                <div
                  id="vibe-bar"
                  class="bg-amber-500 h-5 rounded-full score-bar-fill"
                  style="width: 0%"
                ></div>
              </div>
              <p
                id="vibe-critique"
                class="text-base text-gray-700 mt-2 p-3 bg-amber-50 rounded-lg"
              ></p>
            </div>
          </div>

          <div class="mt-8 text-center bg-gray-100 p-4 rounded-xl shadow-inner">
            <h3 class="font-bold text-gray-800 text-lg">AI의 최종 한 줄 평</h3>
            <p id="final-critique" class="text-xl mt-2 text-gray-700 italic">
              "
            </p>
          </div>

          <div
            class="mt-8 text-center border-t-2 border-dashed border-pink-200 pt-6"
          >
            <h3 class="text-2xl font-bold text-gray-800">
              베럴댄미 : 남성그루밍 프로필 서비스
            </h3>
            <p class="text-gray-600 mt-2 text-lg">
              인생 프로필 사진, 전문가와 함께!
            </p>
            <div class="flex justify-center space-x-4 mt-4">
              <a
                href="https://www.instagram.com/better.than.me2040/"
                target="_blank"
                rel="noopener noreferrer"
                class="bg-gradient-to-r from-pink-500 to-orange-400 text-white py-2 px-5 rounded-lg hover:shadow-lg transition-shadow text-base"
                >인스타그램</a
              >
              <a
                href="https://open.kakao.com/o/sDAisnDh"
                target="_blank"
                rel="noopener noreferrer"
                class="bg-yellow-400 text-gray-800 py-2 px-5 rounded-lg hover:shadow-lg transition-shadow text-base"
                >오픈채팅</a
              >
            </div>
            <p class="text-sm text-gray-500 mt-2">
              프로필사진 및 냉정한 외모평가를 원한다면 오픈채팅으로 연락주세요
            </p>
          </div>

          <div class="mt-6 text-center">
            <button
              onclick="resetApp()"
              class="w-full bg-fuchsia-500 text-white font-bold py-3 px-4 rounded-xl text-lg hover:bg-fuchsia-600 transition-all duration-300 transform hover:scale-105 shadow-lg"
            >
              다른 사진으로 또 하기! 📸
            </button>
          </div>
        </div>

        <!-- Custom Alert Modal -->
        <div
          id="alert-modal"
          class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
        >
          <div
            class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center transform transition-all animate-in zoom-in-75"
          >
            <p id="alert-message" class="text-gray-700 text-xl"></p>
            <button
              onclick="closeModal()"
              class="mt-8 bg-fuchsia-500 text-white font-bold py-2 px-8 rounded-lg hover:bg-fuchsia-600 transition-colors text-lg"
            >
              알겠어요!
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const uploadSection = document.getElementById("upload-section");
      const contactSection = document.getElementById("contact-section");
      const loadingSection = document.getElementById("loading-section");
      const resultSection = document.getElementById("result-section");
      const imageUpload = document.getElementById("image-upload");
      const imagePreview = document.getElementById("image-preview");
      const uploadPlaceholder = document.getElementById("upload-placeholder");
      const nextButton = document.getElementById("next-button");
      const resultImage = document.getElementById("result-image");
      const contactForm = document.getElementById("contact-form");

      const alertModal = document.getElementById("alert-modal");
      const alertMessage = document.getElementById("alert-message");

      let uploadedImageBase64 = null;
      // 요청 상관관계를 위한 고유 ID 생성 (두 단계 전송에 사용)
      let requestId =
        crypto && crypto.randomUUID
          ? crypto.randomUUID()
          : `${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
      // Google Apps Script 웹앱 URL (시트 기록용)
      // const scriptURL = "<moved-to-server>"; // Apps Script 호출은 서버(Netlify 함수)에서만 수행

      // 방문자/환경 메타 수집 (clientId + FingerprintJS + IP/UA/lang/referrer)
      window.__clientId =
        localStorage.getItem("clientId") ||
        (() => {
          const id =
            crypto && crypto.randomUUID
              ? crypto.randomUUID()
              : `${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
          try {
            localStorage.setItem("clientId", id);
          } catch (_) {}
          return id;
        })();
      window.__ua = navigator.userAgent;
      window.__lang =
        navigator.language ||
        (navigator.languages && navigator.languages[0]) ||
        "";
      window.__referrer = document.referrer || "";

      window.__visitorId = "";
      if (window.FingerprintJS && FingerprintJS.load) {
        FingerprintJS.load()
          .then((fp) => fp.get())
          .then((res) => {
            window.__visitorId = res.visitorId;
          })
          .catch(() => {});
      }

      // 최초 유입 referrer 보존 (브라우저 정책/직접 방문으로 비어질 수 있으므로 보조 신호로 저장)
      try {
        if (!localStorage.getItem("firstReferrer") && document.referrer) {
          localStorage.setItem("firstReferrer", document.referrer);
        }
      } catch (_) {}

      // visitorId 준비를 잠시 대기 (FingerprintJS가 비동기여서 초기 제출 시 누락 방지)
      async function waitForVisitorId(timeoutMs = 800) {
        const start = Date.now();
        while (!window.__visitorId && Date.now() - start < timeoutMs) {
          await new Promise((r) => setTimeout(r, 50));
        }
        return window.__visitorId || "";
      }

      window.__clientIp = "";
      fetch("https://api.ipify.org?format=json")
        .then((r) => r.json())
        .then((d) => {
          window.__clientIp = d.ip;
        })
        .catch(() => {});

      // 이미지 업로드 처리
      imageUpload.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            uploadedImageBase64 = e.target.result;
            imagePreview.src = uploadedImageBase64;
            imagePreview.classList.remove("hidden");
            uploadPlaceholder.classList.add("hidden");
            nextButton.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        }
      });

      // '정보 입력' 버튼 클릭 -> 연락처 폼으로 이동
      nextButton.addEventListener("click", () => {
        if (!uploadedImageBase64) {
          showAlert("먼저 사진을 선택해주세요!");
          return;
        }
        switchView("contact-section");
      });

      // 연락처 입력 자동 포맷팅
      document
        .getElementById("user-contact")
        .addEventListener("input", (event) => {
          let value = event.target.value.replace(/[^0-9]/g, ""); // 숫자만 남기기

          if (value.length >= 3) {
            value = value.substring(0, 3) + "-" + value.substring(3);
          }
          if (value.length >= 8) {
            value = value.substring(0, 8) + "-" + value.substring(8, 12);
          }

          event.target.value = value;
        });

      // 이름 유효성 검사 함수
      function validateName(name) {
        const trimmedName = name.trim();

        // 빈 문자열이거나 공백만 있는 경우
        if (!trimmedName || trimmedName.length < 2) {
          return false;
        }

        // 연속된 공백이 있는지 확인
        if (trimmedName.includes("  ")) {
          return false;
        }

        // 한글, 영문, 공백만 허용, 2-10글자
        const nameRegex = /^[가-힣a-zA-Z\s]{2,10}$/;
        if (!nameRegex.test(trimmedName)) {
          return false;
        }

        // 의성어나 무의미한 패턴 검사
        const invalidPatterns = [
          /^(.)\1+$/, // 같은 글자 반복 (예: 가가가, aaa)
          /^[ㄱ-ㅎㅏ-ㅣ]+$/, // 자음이나 모음만
          /(하{2,}|히{2,}|후{2,}|헤{2,}|호{2,})/, // 하하하, 히히히 등
          /^(하|히|후|헤|호|ㅋ|ㅎ|ㄷ|ㄴ|ㄹ|ㅁ|ㅂ|ㅅ|ㅇ|ㅈ|ㅊ|ㅌ|ㅍ)+$/, // 의성어/자모 반복
          /^[0-9!@#$%^&*()_+=\-\[\]{}|;:,.<>?]+$/, // 숫자나 특수문자만
          /(test|테스트|ㅋㅋ+|ㅎㅎ+|ㄷㄷ|ㄴㄴ)/i, // 테스트/채팅 용어
          /(하히후헤호|아하하하|우하하|으하하)/, // 대표 의성어
        ];

        for (const pattern of invalidPatterns) {
          if (pattern.test(trimmedName)) {
            return false;
          }
        }

        return true;
      }

      // 연락처 유효성 검사 함수
      function validatePhoneNumber(phone) {
        const phoneRegex = /^010-\d{4}-\d{4}$/;
        return phoneRegex.test(phone);
      }

      // 연락처 폼 제출 -> 분석 시작
      contactForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const name = document.getElementById("user-name").value;
        const contact = document.getElementById("user-contact").value;

        if (!name || !contact) {
          showAlert("이름과 연락처를 모두 입력해주세요!");
          return;
        }

        if (!validateName(name)) {
          showAlert(
            "올바른 사람 이름을 입력해주세요! 의성어나 무의미한 문자는 사용할 수 없습니다."
          );
          return;
        }

        if (!validatePhoneNumber(contact)) {
          showAlert("연락처는 010-1234-5678 형식으로 입력해주세요!");
          return;
        }

        const consentChecked =
          document.getElementById("contact-consent")?.checked;
        if (!consentChecked) {
          showAlert("개인정보 수집 및 이용에 동의해주세요.");
          return;
        }

        // UI 상태 변경: 로딩
        switchView("loading-section");
        // 서버로 단일 요청 (create + analyze + update)
        try {
          // 제출 직전 잠시 visitorId 대기
          await waitForVisitorId(800);
          let persistedReferrer = "";
          try {
            persistedReferrer = localStorage.getItem("firstReferrer") || "";
          } catch (_) {}

          const payload = {
            mode: "full",
            requestId,
            name,
            contact,
            timestamp: new Date().toLocaleString("ko-KR"),
            imageBase64: uploadedImageBase64,
            consent: !!consentChecked,
            clientId: window.__clientId || "",
            visitorId: window.__visitorId || "",
            ip: window.__clientIp || "",
            ua: window.__ua || "",
            lang: window.__lang || "",
            referrer: window.__referrer || persistedReferrer || "",
          };

          const res = await fetch("/.netlify/functions/analyzeImage", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            throw new Error(`Server error ${res.status}`);
          }
          const data = await res.json();
          const result = data.result || data; // 호환 처리

          if (!result.isValid) {
            showAlert(
              result.reason ||
                "앗! 실제 인물 사진을 넣어야 정확한 평가가 가능해요."
            );
            resetToUpload();
            return;
          }

          displayResults(result);
        } catch (error) {
          console.error("Error during analysis:", error);
          showAlert(
            "분석 중 서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요."
          );
          resetToUpload();
        }
      });

      // Gemini API 호출 함수 (수정됨)
      async function callGeminiAPI(prompt, imageBase64) {
        const apiUrl = `/.netlify/functions/analyzeImage`;
        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            // *** FIX: prompt와 imageBase64를 함께 보냅니다. ***
            body: JSON.stringify({
              prompt: prompt, // <-- 이 부분을 추가!
              imageBase64: imageBase64,
            }),
          });

          if (!response.ok) {
            throw new Error(
              `Serverless function failed with status ${response.status}`
            );
          }

          const result = await response.json();

          // AI가 유해성 등으로 답변을 거부했을 경우의 처리
          if (result.promptFeedback && result.promptFeedback.blockReason) {
            console.error(
              "Analysis blocked by API:",
              result.promptFeedback.blockReason
            );
            showAlert("AI가 분석을 거부했어요. 다른 사진으로 시도해보세요.");
            throw new Error("API content blocked");
          }

          if (result.candidates && result.candidates[0].content.parts[0].text) {
            return result.candidates[0].content.parts[0].text;
          } else {
            throw new Error(
              "Invalid API response format from serverless function"
            );
          }
        } catch (error) {
          console.error("Error calling serverless function:", error);
          if (error.message !== "API content blocked") {
            showAlert(
              "분석 중 서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요."
            );
          }
          throw error; // 오류를 다시 던져서 후속 처리를 막습니다.
        }
      }

      // 결과 표시 함수
      function displayResults(data) {
        resultImage.src = uploadedImageBase64;

        document.getElementById(
          "figure-score"
        ).textContent = `${data.figureScore}점`;
        document.getElementById(
          "background-score"
        ).textContent = `${data.backgroundScore}점`;
        document.getElementById(
          "vibe-score"
        ).textContent = `${data.vibeScore}점`;

        const figureBar = document.getElementById("figure-bar");
        const backgroundBar = document.getElementById("background-bar");
        const vibeBar = document.getElementById("vibe-bar");

        // 애니메이션을 위해 스타일 변수 설정
        figureBar.style.setProperty("--target-width", `${data.figureScore}%`);
        backgroundBar.style.setProperty(
          "--target-width",
          `${data.backgroundScore}%`
        );
        vibeBar.style.setProperty("--target-width", `${data.vibeScore}%`);

        document.getElementById("figure-critique").textContent =
          data.figureCritique;
        document.getElementById("background-critique").textContent =
          data.backgroundCritique;
        document.getElementById("vibe-critique").textContent =
          data.vibeCritique;
        document.getElementById(
          "final-critique"
        ).textContent = `"${data.finalCritique}"`;

        // UI 상태 변경: 결과
        switchView("result-section");
      }

      // 커스텀 알림창 보이기
      function showAlert(message) {
        alertMessage.textContent = message;
        alertModal.classList.remove("hidden");
      }

      // 커스텀 알림창 닫기
      function closeModal() {
        alertModal.classList.add("hidden");
      }

      function switchView(viewId) {
        document.querySelectorAll(".view-section").forEach((section) => {
          section.classList.add("hidden");
        });
        document.getElementById(viewId).classList.remove("hidden");
      }

      // 초기 업로드 화면으로 리셋
      function resetToUpload() {
        switchView("upload-section");
      }

      // 전체 앱 리셋
      function resetApp() {
        uploadedImageBase64 = null;
        imagePreview.src = "";
        imagePreview.classList.add("hidden");
        uploadPlaceholder.classList.remove("hidden");
        nextButton.classList.add("hidden");
        contactForm.reset();
        resetToUpload();
      }
    </script>
  </body>
</html>
